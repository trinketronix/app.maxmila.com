<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><?=$pageTitle?></title>

    <!-- Bootstrap 5.1 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome CDN for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <!-- Vanilla Datepicker CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker-bs5.min.css">

    <style>
        html, body {
            height: 100vh;
            overflow: hidden;
            background-color: #f0f2f5;
            font-family: 'Segoe UI', 'Roboto', sans-serif;
        }
        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 500px;
            margin: 0 auto;
            background-color: #ffffff;
            border-left: 1px solid #dcdcdc;
            border-right: 1px solid #dcdcdc;
            position: relative;
        }

        /* --- Header & Controls (Fixed) --- */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 1rem; position: relative; flex-shrink: 0; }
        .back-button { text-decoration: none; color: #333; font-weight: 500; }
        .header-title { font-size: 2.2rem; font-weight: bold; margin: 0; position: absolute; left: 50%; transform: translateX(-50%); }
        .profile { text-align: center; }
        .profile-icon { font-size: 1.5rem; border: 2px solid #000; border-radius: 50%; width: 45px; height: 45px; display: flex; align-items: center; justify-content: center; margin: 0 auto; overflow: hidden; }
        .profile-icon img { width: 100%; height: 100%; object-fit: cover; }
        .profile-username { font-size: 0.8rem; color: #555; margin-top: 4px; }
        .controls-section { padding: 1rem; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; }
        .search-bar .form-control, .search-bar .btn { border-radius: 8px; border: 2px solid #000; }
        .filter-group { border: 2px solid #000; border-radius: 10px; padding: 0.5rem; }
        .filter-buttons { display: flex; overflow-x: auto; gap: 0.5rem; }
        .filter-btn { border: 2px solid #000; border-radius: 8px; background-color: #fff; color: #000; font-weight: 500; white-space: nowrap; }
        .filter-btn.active { background-color: #000; color: #fff; }
        .filter-buttons::-webkit-scrollbar { display: none; }

        /* --- Visit List --- */
        .visit-list-container {
            flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 120px;
        }
        .visit-card {
            display: grid; grid-template-columns: 1fr auto 1fr; align-items: center;
            border: 2px solid #000; border-radius: 15px; padding: 1rem; margin-bottom: 1rem;
            text-decoration: none; color: inherit; transition: background-color 0.2s;
        }
        .visit-card:hover { background-color: #f1f1f1; }
        .visit-person { text-align: center; }
        .visit-person-avatar { width: 60px; height: 60px; border: 3px solid #000; border-radius: 50%; overflow: hidden; margin: 0 auto 0.5rem auto; }
        .visit-person-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .visit-person-name { font-weight: 500; }
        .visit-details { text-align: center; }
        .visit-date { font-weight: bold; font-size: 1.1rem; }
        .visit-relative-time, .visit-progress { color: #555; }
        .visit-progress-canceled { color: #dc3545; font-weight: bold; }

        /* --- Offcanvas & Tabs --- */
        .fab { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90px; height: 90px; border-radius: 50%; background-color: #e0e0e0; border: 3px solid #000; display: flex; flex-direction: column; align-items: center; justify-content: center; font-weight: 500; text-decoration: none; color: #000; z-index: 1040; }
        #assignVisitOffcanvas .nav-tabs .nav-link { border: 2px solid #000 !important; border-bottom: 0 !important; color: #000; margin-right: 2px; }
        #assignVisitOffcanvas .nav-tabs .nav-link.active { background-color: #0d6efd; color: #fff; border-color: #0d6efd !important;}
        #assignVisitOffcanvas .nav-tabs .nav-link.disabled { color: #aaa; border-color: #aaa !important; background-color: #f8f9fa; }
        .tab-pane { padding-top: 1rem; }
        .selection-list { max-height: 300px; overflow-y: auto; }
        .selection-item { display: flex; align-items: center; gap: 1rem; border: 2px solid #ccc; border-radius: 15px; padding: 0.75rem; margin-bottom: 0.5rem; cursor: pointer; }
        .selection-item.selected { border-color: #0d6efd; background-color: #eef5ff; }
        .selection-item-avatar { width: 45px; height: 45px; }
        #create-visit-btn { border: 2px solid #000; font-weight: bold; }

        /* Custom Time Picker */
        .time-picker-container { display: flex; flex-direction: column; align-items: center; }
        .time-picker-display { font-size: 4rem; font-weight: bold; }
        .time-picker-clock { position: relative; width: 250px; height: 250px; border: 3px solid #000; border-radius: 50%; margin: 1rem 0; }
        .time-picker-hand { position: absolute; bottom: 50%; left: 50%; width: 2px; height: 40%; background-color: #0d6efd; transform-origin: bottom; }
        .time-picker-handle { position: absolute; top: -10px; left: -9px; width: 20px; height: 20px; background-color: #0d6efd; border-radius: 50%; }

        @media (min-width: 768px) { .page-container { max-width: 720px; } }
    </style>
</head>
<body onload="initializePage()">

<div id="alert-container" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); z-index: 2000; width: 90%; max-width: 480px;"></div>

<div class="page-container">
    <!-- Header -->
    <header class="header">
        <a href="/dashboard/admin" class="back-button"><i class="fas fa-chevron-left"></i> Exit</a>
        <h1 class="header-title">Visits</h1>
        <div class="profile">
            <div class="profile-icon"><img src="<?=$photo?>" alt="avatar"></div>
            <span class="profile-username"><?=$fullname?></span>
        </div>
    </header>

    <!-- Controls -->
    <section class="controls-section">
        <div class="input-group search-bar mb-3">
            <input type="text" id="search-input-main" class="form-control" placeholder="Search visit...">
            <button class="btn btn-dark" type="button">Search</button>
        </div>
        <div class="filter-group mb-2">
            <div class="filter-buttons"><small class="align-self-center me-2">Status:</small>
                <button class="btn filter-btn active" data-filter-type="recordStatus" data-filter-value="all">All</button>
                <button class="btn filter-btn" data-filter-type="recordStatus" data-filter-value="1">Visible</button>
                <button class="btn filter-btn" data-filter-type="recordStatus" data-filter-value="2">Archived</button>
                <button class="btn filter-btn" data-filter-type="recordStatus" data-filter-value="3">Deleted</button>
            </div>
        </div>
        <div class="filter-group">
            <div class="filter-buttons"><small class="align-self-center me-2">Progress:</small>
                <button class="btn filter-btn active" data-filter-type="visitProgress" data-filter-value="all">All</button>
                <button class="btn filter-btn" data-filter-type="visitProgress" data-filter-value="0">Scheduled</button>
                <button class="btn filter-btn" data-filter-type="visitProgress" data-filter-value="1">Check-in</button>
                <button class="btn filter-btn" data-filter-type="visitProgress" data-filter-value="2">Check-out</button>
                <button class="btn filter-btn" data-filter-type="visitProgress" data-filter-value="3">Approved</button>
                <button class="btn filter-btn" data-filter-type="visitProgress" data-filter-value="-1">Canceled</button>
            </div>
        </div>
    </section>

    <!-- Visit List -->
    <main class="visit-list-container">
        <div id="visit-list">
            <div class="text-center p-5"><div class="spinner-border"></div></div>
        </div>
    </main>
</div>

<!-- FAB to Add Visit -->
<a href="#" class="fab" id="add-visit-btn">
    <div class="plus-icon">+</div>
    <div>Visit</div>
</a>

<!-- Offcanvas for Add Visit Form -->
<div class="offcanvas offcanvas-bottom h-100" tabindex="-1" id="assignVisitOffcanvas">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title w-100 text-center">Select</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column">
        <!-- Tabs -->
        <ul class="nav nav-tabs" id="visit-tabs" role="tablist">
            <li class="nav-item" role="presentation"><button class="nav-link active" id="caregiver-tab-btn" data-bs-toggle="tab" data-bs-target="#caregiver-tab" type="button">Caregiver</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link disabled" id="patient-tab-btn" data-bs-toggle="tab" data-bs-target="#patient-tab" type="button">Patient</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link disabled" id="address-tab-btn" data-bs-toggle="tab" data-bs-target="#address-tab" type="button">Address</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="date-tab-btn" data-bs-toggle="tab" data-bs-target="#date-tab" type="button">Date</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="start-tab-btn" data-bs-toggle="tab" data-bs-target="#start-tab" type="button">Start</button></li>
            <li class="nav-item" role="presentation"><button class="nav-link" id="end-tab-btn" data-bs-toggle="tab" data-bs-target="#end-tab" type="button">End</button></li>
        </ul>
        <!-- Tab Content -->
        <div class="tab-content flex-grow-1" id="visit-tabs-content">
            <div class="tab-pane fade show active" id="caregiver-tab">
                <div class="input-group search-bar mb-2"><input type="text" class="form-control" placeholder="Search caregiver..."></div>
                <div class="selection-list" id="caregiver-selection-list"></div>
            </div>
            <div class="tab-pane fade" id="patient-tab">
                <div id="patient-selection-placeholder" class="text-center text-muted mt-5">Please select a caregiver first.</div>
                <div id="patient-selection-content" style="display:none;">
                    <div class="input-group search-bar mb-2"><input type="text" class="form-control" placeholder="Search patient..."></div>
                    <div class="selection-list" id="patient-selection-list"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="address-tab">
                <div id="address-selection-placeholder" class="text-center text-muted mt-5">Please select a patient first.</div>
                <div id="address-selection-content" style="display:none;">
                    <div class="input-group search-bar mb-2"><input type="text" class="form-control" placeholder="Search address..."></div>
                    <div class="selection-list" id="address-selection-list"></div>
                </div>
            </div>
            <div class="tab-pane fade" id="date-tab">
                <div id="datepicker-container"></div>
            </div>
            <div class="tab-pane fade" id="start-tab">
                <div class="time-picker-container" id="start-time-picker"></div>
            </div>
            <div class="tab-pane fade" id="end-tab">
                <div class="time-picker-container" id="end-time-picker"></div>
            </div>
        </div>
        <button type="button" class="btn btn-primary mt-3" id="create-visit-btn" style="display:none;">Create Visit</button>
    </div>
</div>

<!-- Confirmation Modal for Visit Creation -->
<div class="modal fade" id="visitConfirmationModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Confirm Visit</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body" id="visit-confirmation-text"></div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirm-create-visit-btn">OK</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>

<script>
    const baseUrl = '<?=$baseUrl?>';
    const authToken = '<?=$authToken?>';

    // --- State for the new visit form ---
    const newVisitState = {
        caregiverId: null, caregiverFullname: null,
        patientId: null, patientFullname: null,
        addressId: null, address: null,
        visitDate: null,
        startTime: null, // as { h: 8, m: 30 }
        endTime: null,
    };

    let allVisits = [];
    let visitConfirmationModal, assignVisitOffcanvas;

    // --- HELPER & RENDER FUNCTIONS ---
    const showAlert = (message, type = 'success') => { /* ... same as before ... */ };

    const renderSelectionList = (items, containerId, type) => {
        const listContainer = $(`#${containerId}`);
        listContainer.empty();
        if (!items || items.length === 0) {
            listContainer.html(`<p class="text-center text-muted mt-3">No ${type}s found.</p>`);
            return;
        }
        items.forEach(item => {
            let id, name, photo, iconClass = 'fa-user';
            if(type === 'caregiver' || type === 'patient') {
                id = item.id;
                name = `${item.firstname || ''} ${item.lastname || ''}`.trim();
                photo = (item.photo && !item.photo.endsWith('default.jpg')) ? (baseUrl + item.photo) : 'https://via.placeholder.com/45';
            } else { // address
                id = item.id;
                name = `${item.address}, ${item.city}, ${item.state} ${item.zipcode}`;
                photo = null; // No photo for address
                iconClass = item.type === 'Apartment' ? 'fa-building' : 'fa-house';
            }

            const itemHtml = `
                <div class="selection-item" data-id="${id}" data-name="${name}">
                    <div class="item-avatar selection-item-avatar">
                        ${photo ? `<img src="${photo}" class="rounded-circle w-100 h-100" style="object-fit:cover;" alt="Avatar">` : `<i class="fa-solid ${iconClass} fs-3"></i>`}
                    </div>
                    <div>${name}</div>
                </div>`;
            listContainer.append(itemHtml);
        });
    };

    const renderVisitList = (visits) => { /* ... logic to render main list ... */ };
    const getRelativeTime = (dateStr) => { /* ... logic to get "in 22 days", "today", etc. ... */ };
    const getProgressText = (progress) => { /* ... logic for "Scheduled", "Canceled" ... */ };

    const checkFormCompleteness = () => {
        const { caregiverId, patientId, addressId, visitDate, startTime, endTime } = newVisitState;
        if (caregiverId && patientId && addressId && visitDate && startTime && endTime) {
            $('#create-visit-btn').fadeIn();
        } else {
            $('#create-visit-btn').fadeOut();
        }
    };

    // --- API CALLS ---
    const fetchAllVisits = () => { /* ... logic to fetch main visit list ... */ };
    const fetchCaregivers = () => $.ajax({ url: `${baseUrl}/accounts`, headers: { 'Authorization': authToken } });
    const fetchAssignedPatients = (caregiverId) => $.ajax({ url: `${baseUrl}/assigned/patients/${caregiverId}`, headers: { 'Authorization': authToken } });
    const fetchPatientAddresses = (patientId) => $.ajax({ url: `${baseUrl}/address/person/${patientId}/1`, headers: { 'Authorization': authToken } });

    // --- INITIALIZATION ---
    function initializePage() {
        visitConfirmationModal = new bootstrap.Modal(document.getElementById('visitConfirmationModal'));
        assignVisitOffcanvas = new bootstrap.Offcanvas(document.getElementById('assignVisitOffcanvas'));

        // Init Datepicker
        const datepickerElem = document.getElementById('datepicker-container');
        const datepicker = new Datepicker(datepickerElem, { format: 'yyyy-mm-dd', autohide: true });
        datepickerElem.addEventListener('changeDate', function(e) {
            newVisitState.visitDate = e.detail.date;
            checkFormCompleteness();
        });

        // Init Timepickers (custom logic would go here or use a library)
        // For this example, we'll just simulate it
        $('#start-time-picker').html('<p class="text-muted">Start Time Picker UI</p><button class="btn btn-sm btn-info" id="sim-start">Set 9:00 AM</button>');
        $('#end-time-picker').html('<p class="text-muted">End Time Picker UI</p><button class="btn btn-sm btn-info" id="sim-end">Set 3:00 PM</button>');
        $('#sim-start').on('click', () => { newVisitState.startTime = {h:9, m:0}; checkFormCompleteness(); showAlert('Start time set to 9:00 AM'); });
        $('#sim-end').on('click', () => { newVisitState.endTime = {h:15, m:0}; checkFormCompleteness(); showAlert('End time set to 3:00 PM'); });


        // --- Event Listeners for Offcanvas ---
        $('#add-visit-btn').on('click', (e) => {
            e.preventDefault();
            fetchCaregivers().done(res => renderSelectionList(res.data.users, 'caregiver-selection-list', 'caregiver'));
            assignVisitOffcanvas.show();
        });

        // Caregiver selection
        $('#caregiver-selection-list').on('click', '.selection-item', function() {
            const el = $(this);
            newVisitState.caregiverId = el.data('id');
            newVisitState.caregiverFullname = el.data('name');
            el.addClass('selected').siblings().removeClass('selected');
            $('#patient-tab-btn').removeClass('disabled').click();
            fetchAssignedPatients(newVisitState.caregiverId).done(res => {
                $('#patient-selection-placeholder').hide();
                $('#patient-selection-content').show();
                renderSelectionList(res.data.patients, 'patient-selection-list', 'patient');
            });
            checkFormCompleteness();
        });

        // Patient selection
        $('#patient-selection-list').on('click', '.selection-item', function() {
            const el = $(this);
            newVisitState.patientId = el.data('id');
            newVisitState.patientFullname = el.data('name');
            el.addClass('selected').siblings().removeClass('selected');
            $('#address-tab-btn').removeClass('disabled').click();
            fetchPatientAddresses(newVisitState.patientId).done(res => {
                $('#address-selection-placeholder').hide();
                $('#address-selection-content').show();
                renderSelectionList(res.data, 'address-selection-list', 'address');
            });
            checkFormCompleteness();
        });

        // Address selection
        $('#address-selection-list').on('click', '.selection-item', function() {
            const el = $(this);
            newVisitState.addressId = el.data('id');
            newVisitState.address = el.data('name');
            el.addClass('selected').siblings().removeClass('selected');
            $('#date-tab-btn').click(); // Move to next tab
            checkFormCompleteness();
        });

        // "Create Visit" button in Offcanvas
        $('#create-visit-btn').on('click', function() {
            // Format data and show confirmation modal
            const { patientFullname, caregiverFullname, visitDate, startTime, endTime } = newVisitState;
            const visitDay = new Date(visitDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric'});
            const startStr = `${startTime.h % 12 || 12}:${String(startTime.m).padStart(2,'0')} ${startTime.h >= 12 ? 'PM' : 'AM'}`;
            const endStr = `${endTime.h % 12 || 12}:${String(endTime.m).padStart(2,'0')} ${endTime.h >= 12 ? 'PM' : 'AM'}`;
            const duration = (endTime.h * 60 + endTime.m) - (startTime.h * 60 + startTime.m);
            const durationHours = Math.floor(duration / 60);

            $('#visit-confirmation-text').html(`A visit for <strong>${patientFullname}</strong> will be created on <strong>${visitDay}</strong>, starting at ${startStr} and ending at ${endStr}, attended by <strong>${caregiverFullname}</strong> for ${durationHours} hrs.`);
            visitConfirmationModal.show();
        });

        // Final confirmation in Modal
        $('#confirm-create-visit-btn').on('click', function() {
            // Construct payload and send API request
            const { caregiverId, patientId, addressId, visitDate, startTime, endTime } = newVisitState;
            const startDatetime = new Date(visitDate);
            startDatetime.setHours(startTime.h, startTime.m, 0, 0);
            const endDatetime = new Date(visitDate);
            endDatetime.setHours(endTime.h, endTime.m, 0, 0);

            const payload = {
                user_id: caregiverId, patient_id: patientId, address_id: addressId,
                start_time: startDatetime.toISOString().slice(0, 19).replace('T', ' '),
                end_time: endDatetime.toISOString().slice(0, 19).replace('T', ' '),
            };

            $.ajax({
                url: `${baseUrl}/visit`, type: 'POST',
                headers: { 'Authorization': authToken, 'Content-Type': 'application/json' },
                data: JSON.stringify(payload),
                success: () => {
                    showAlert('Visit created successfully!', 'success');
                    visitConfirmationModal.hide();
                    assignVisitOffcanvas.hide();
                    fetchAllVisits(); // Refresh main list
                },
                error: () => showAlert('Failed to create visit.', 'danger')
            });
        });
    }
</script>
</body>
</html>