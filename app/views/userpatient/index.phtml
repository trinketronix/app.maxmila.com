<style>
    html { scroll-behavior: smooth; }

    body {
        background-color: #ffe0ef;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 18px;
        color: #333;
    }

    .sticky-header {
        position: sticky;
        top: 0;
        background-color: #fce6f5;
        padding: 20px 10px;
        z-index: 1000;
        box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        text-align: center;
        margin-bottom: 20px;
    }

    .sticky-header h3 {
        font-size: 28px;
        margin: 0;
        color: #d63384;
    }

    .sticky-header h4 {
        font-size: 22px;
        margin: 0;
        color: #c2185b;
    }

    .container {
        max-width: 960px;
        padding: 30px 20px;
        margin: 0 auto;
    }

    h5 {
        text-align: center;
        color: #d63384;
        font-size: 22px;
        margin-bottom: 15px;
    }

    .btn-back {
        margin-bottom: 30px;
        text-align: center;
    }

    .btn-back a {
        font-size: 18px;
        color: #d63384;
        text-decoration: none;
    }

    .flash-messages {
        margin-bottom: 20px;
        text-align: center;
        color: green;
        font-weight: bold;
        font-size: 18px;
    }

    .manager-row {
        background-color: #fff;
        border-left: 6px solid #e83e8c;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
        padding: 25px;
        border-radius: 12px;
        display: flex;
        justify-content: space-between;
        gap: 25px;
    }

    .column {
        flex: 1;
        min-width: 240px;
    }

    .column ul {
        list-style: none;
        padding: 0;
    }

    .column li {
        margin-bottom: 12px;
        font-size: 18px;
    }

    input[type="checkbox"] {
        transform: scale(1.3);
        margin-right: 8px;
    }

    .action-buttons {
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        gap: 15px;
    }

    .btn-danger {
        background-color: #e83e8c;
        color: white;
        padding: 14px 24px;
        font-size: 18px;
        border: none;
        border-radius: 30px;
        cursor: pointer;
        transition: background-color 0.3s ease;
        font-weight: bold;
        width: 180px;
    }

    .btn-danger:hover {
        background-color: #c2185b;
    }

    /* Spinner */
    #loadingSpinner {
        display: none;
        text-align: center;
        margin-bottom: 20px;
    }

    .spinner {
        width: 40px;
        height: 40px;
        border: 5px solid #d63384;
        border-top: 5px solid transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }
</style>



<div class="sticky-header">
    <h3>Patient Assignment Manager</h3>
    <h4>Caregiver: <?= $userName ?></h4>
</div>
<div class="btn-back" onclick="window.history.back();">
    <a href="/main" class="btn-action">
        <i class="bi bi-arrow-left-circle"></i> <span>Back to Menu</span>
    </a>

</div>


<div class="container">
    <div id="loadingSpinner">
        <div class="spinner"></div>
        <small>Loading...</small>
    </div>

    <div class="flash-messages" id="flashMsg"></div>

    <div class="manager-row">
        <!-- Column A -->
        <div class="column">
            <h5>Assigned Patients</h5>
            <!-- Assigned patients -->
            <ul id="assignedList">
                <?php foreach ($assignedPatients as $patient): ?>
                    <li>
                        <label>
                            <input type="checkbox" class="assigned-checkbox" value="<?= $patient['id'] ?>">
                            <?= $patient['id'] ?> - <?= $patient['lastname'] ?> <?= $patient['firstname'] ?>
                        </label>
                    </li>
                <?php endforeach; ?>
            </ul>
        </div>

        <!-- Column B -->
        <div class="column action-buttons">
            <button class="btn-danger" onclick="assignPatients()">&laquo; Assign </button>
            <button class="btn-danger" onclick="unassignPatients()">Unassign &raquo;</button>
        </div>

        <!-- Column C -->
        <div class="column">
            <h5>Unassigned Patients</h5>
            <!-- Unassigned patients -->
            <ul id="unassignedList">
                <?php foreach ($unassignedPatients as $patient): ?>
                    <li>
                        <label>
                            <input type="checkbox" class="unassigned-checkbox" value="<?= $patient['id'] ?>">
                            <?= $patient['id'] ?> - <?= $patient['lastname'] ?> <?= $patient['firstname'] ?>
                        </label>
                    </li>
                <?php endforeach; ?>
            </ul>

        </div>
    </div>
</div>

<script>
    function getCheckedValues(className) {
        return Array.from(document.querySelectorAll('.' + className + ':checked')).map(cb => cb.value);
    }

    function assignPatients() {
        const baseUrl = "<?= $baseURL ?>";
        const token = "<?= $token ?>"; // If you're using token too
        const selected = getCheckedValues('unassigned-checkbox');
        if (selected.length === 0) return alert("Select patients to assign.");
        toggleSpinner(true);

        fetch(baseUrl+'/assign/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
                'Authorization': token},
            body: JSON.stringify({
                user_id: <?= $userId ?>,
                patient_ids: selected
            })
        }

        )
            .then(res => res.json())
            .then(() => {
                showMessage('Patients assigned successfully.');
                refreshPatientLists();
            })
            .catch(() => showMessage('Assignment failed.'))
            .finally(() => toggleSpinner(false));
    }

    function unassignPatients() {
        const baseUrl = "<?= $baseURL ?>";
       const token = "<?= $token ?>"; // If you're using token too
        const selected = getCheckedValues('assigned-checkbox');
        if (selected.length === 0) return alert("Select patients to unassign.");
        toggleSpinner(true);

        fetch(baseUrl+'/unassign/patients', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json',
            'Authorization': token},
            body: JSON.stringify({
                user_id: <?= $userId ?>,
                patient_ids: selected
            })
        })
            .then(res => res.json())
            .then(() => {
                showMessage('Patients unassigned successfully.');
                refreshPatientLists();
            })
            .catch(() => showMessage('Unassignment failed.'))
            .finally(() => toggleSpinner(false));
    }

    function showMessage(msg) {
        const el = document.getElementById('flashMsg');
        el.innerHTML = msg;
        setTimeout(() => el.innerHTML = '', 3000);
    }

    function toggleSpinner(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function refreshPatientLists() {
        location.reload();
    }
</script>
